x-backend-base: &backend-base
  build:
    context: .
    dockerfile: Dockerfile.backend
  env_file:
    - .env
  expose:
    - "8000"
  networks:
    default:
      aliases:
        - backend

services:
  backend:
    <<: *backend-base

  backend-gpu:
    <<: *backend-base
    profiles:
      - gpu
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      NVIDIA_VISIBLE_DEVICES: all
      NVIDIA_DRIVER_CAPABILITIES: compute,utility

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      - VITE_BACKEND_URL=http://backend:8000
    ports:
      - "5173:5173"
